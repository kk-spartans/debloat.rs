name: CI

on:
  push:
    paths:
      - "**/*.rs"
      - "Cargo.toml"
      - "Cargo.lock"
  pull_request:
    paths:
      - "**/*.rs"
      - "Cargo.toml"
      - "Cargo.lock"

jobs:
  lint:
    name: Format and Clippy
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain with rustfmt + clippy
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt clippy
          profile: minimal

      - name: Cache cargo registry, git and sccache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.USERPROFILE }}/.cargo/registry
            ${{ env.USERPROFILE }}/.cargo/git
            target
            ${{ env.LOCALAPPDATA }}/sccache
          key: ${{ runner.os }}-cargo-fmt-clippy-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings -W clippy::pedantic

  build:
    name: Build matrix
    needs: lint
    runs-on: windows-latest
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    strategy:
      matrix:
        target: [x86_64-pc-windows-msvc, aarch64-pc-windows-msvc]
        profile: [release, optimized]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal

      - name: Setup sccache
        uses: Mozilla-Actions/sccache-action@v0.0.9

      - name: Cache cargo registry, git, target and sccache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.USERPROFILE }}/.cargo/registry
            ${{ env.USERPROFILE }}/.cargo/git
            target
            ${{ env.LOCALAPPDATA }}/sccache
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Build (uses sccache)
        env:
          MATRIX_TARGET: ${{ matrix.target }}
          MATRIX_PROFILE: ${{ matrix.profile }}
          RUSTC_WRAPPER: sccache
        shell: pwsh
        run: |
          if ($env:MATRIX_PROFILE -eq 'release') {
            cargo build --target $env:MATRIX_TARGET --release --locked
          } else {
            cargo build --target $env:MATRIX_TARGET --profile optimized --locked
          }

      - name: sccache --show-stats
        run: sccache --show-stats || true
